window.s=["scripts/c13fdb96e.vknext.js","scripts/13310db55.vknext.js","scripts/2929dba29.vknext.js"];(()=>{"use strict";const e=({src:e,str:s}={})=>{const t=document.createElement("script");t.onload=()=>{t.remove()},s&&(t.async=!1,t.textContent=s),e&&(t.async=!0,t.src=e);(document.body||document.documentElement).appendChild(t)};const s=class{dbName;fixValue;constructor(e,s){this.dbName=e,this.fixValue=s||!1}open(){return new Promise((e,s)=>{const t=indexedDB.open(this.dbName);t.onupgradeneeded=()=>{this.fixValue?t.result.createObjectStore("db"):t.result.createObjectStore("db",{keyPath:"key"})},t.onsuccess=()=>e(t.result),t.onerror=()=>s(t.error)})}async get(e){const s=await this.open(),t=new Promise(t=>{const a=s.transaction("db","readwrite").objectStore("db").get(e);a.onsuccess=()=>{const e=a.result;t(e?.key&&"val"in e?e?.val:e)}});return t.finally(()=>s.close()),await t}async set(e,s){const t=await this.open(),a=t.transaction("db","readwrite").objectStore("db"),n=this.fixValue?a.put(s,e):a.put({key:e,val:s}),r=new Promise((e,s)=>{n.onsuccess=()=>e(),n.onerror=()=>s(n.error)});return r.finally(()=>t.close()),await r}async remove(e){const s=await this.open(),t=s.transaction("db","readwrite").objectStore("db"),a=new Promise((s,a)=>{const n=t.delete(e);n.onsuccess=()=>s(),n.onerror=()=>a(n.error)});return a.finally(()=>s.close()),await a}clearDatabase(){return new Promise((e,s)=>{let t=indexedDB.deleteDatabase(this.dbName);t.onerror=()=>s(t.error),t.onblocked=()=>s("База данных заблокирована"),t.onsuccess=()=>e(t.result)})}},t=new s("vknext-storage-v2",!0);new s("vknext-storage").clearDatabase();const a=t;const n=class{SOURCE_NAME="vkcom-vkn-13";messageHandlers=new Map;pendingMessages=new Map;messageHandler;constructor(){this.messageHandler=async e=>{if(e.origin!==window.origin)return;const s=e.data;if(s?.source!==this.SOURCE_NAME)return;const{type:t,payload:a,id:n,answer:r}=s;if(!0!==r)for(const e of this.messageHandlers.get(t)||[]){const s=e=>{window.postMessage({source:this.SOURCE_NAME,type:t,payload:e,id:n,answer:!0},window.origin)};try{await e(a,s)}catch(e){console.error(e)}}else for(const e of this.pendingMessages.get(n)||[])e&&(e.resolve(a),this.pendingMessages.delete(n))},window.addEventListener("message",this.messageHandler)}sendMessage(e,s){const t=this.generateUniqueId(),a=new Promise(e=>{const s=this.pendingMessages.get(t)||[];s.push({resolve:e}),this.pendingMessages.set(t,s)});return window.postMessage({source:this.SOURCE_NAME,type:e,payload:s,id:t,answer:!1},window.origin),a}addMessageHandler(e,s){const t=this.messageHandlers.get(e)||[];return t.push(s),this.messageHandlers.set(e,t),()=>this.removeMessageHandler(e,s)}removeMessageHandler(e,s){const t=this.messageHandlers.get(e)||[],a=t.indexOf(s);-1!==a&&t.splice(a,1),this.messageHandlers.set(e,t)}requestCount=0;generateUniqueId(){return this.requestCount++}},r=(e,s)=>{console.error(e);const{message:t}=e;t.includes("Extension context invalidated")&&window.confirm(`[VK Next/${s}] ${t} Tab reboot required.`)&&window.location.reload()},o=async(e,s)=>{try{const t=(await chrome.storage.local.get(e))[e];await H(e,t),s(t)}catch(e){r(e,"getStorage")}},c=async(e,s)=>{try{s({...chrome.runtime.getManifest(),id:chrome.runtime.id,url:chrome.runtime.getURL("")})}catch(e){r(e,"getManifest")}},i=async(e,s)=>{try{const e=(await chrome.storage.sync.get("primeStatus")).primeStatus;s({primeIsShown:e?.primeIsShown||!1,deluxeIsShown:e?.deluxeIsShown||!1})}catch(e){r(e,"getPrimesStatus")}},d=globalThis.location.host.split(".");let l;l="vk"!==d[0]?"vk.ru":`vk.${d[d.length-1]||"ru"}`;const g=l,h=async(e,s)=>{try{const t=new URLSearchParams({scope:501202911..toString(),client_id:2685278..toString(),redirect_uri:`https://oauth.${g}/blank.html`,response_type:"token",display:"mobile",revoke:"1",state:`${chrome.runtime.id}_${e.vk_id}_${2685278..toString()}`}),a=`https://oauth.${g}/authorize?${t}#vknext=1`;await chrome.runtime.sendMessage({type:"sw_g_vat",url:a}),s(!0)}catch(e){r(e,"getVkAdminToken")}},m=async(e,s)=>{try{const t=await a.get(e);0,await chrome.storage.local.set({[e]:t}),s(!0)}catch(e){r(e,"onSaveStorage")}},u=async(e,s)=>{try{await chrome.storage.sync.set({primeStatus:{primeIsShown:e.primeIsShown||!1,deluxeIsShown:e.deluxeIsShown||!1}}),s(!0)}catch(e){r(e,"setPrimesStatus")}},w=async(e,s)=>{try{s(await chrome.runtime.sendMessage({type:"sw_a_ath",payload:e}))}catch(e){r(e,"allowAccessToHost")}},y=async(e,s)=>{try{s(await chrome.runtime.sendMessage({type:"sw_gtet",url:e.url}))}catch(e){r(e,"getVkAdminToken")}},p=async(e,s)=>{try{s(await chrome.runtime.sendMessage({type:"sw_reloadVKCOM"}))}catch(e){r(e,"getVkAdminToken")}},v=async(e,s)=>{try{s(await chrome.runtime.sendMessage({type:"sw_ruc"}))}catch(e){r(e,"requestUpdateCheck")}},M=new n;M.addMessageHandler("vkn-b-gm",c),M.addMessageHandler("vkn-b-gs",o),M.addMessageHandler("vkn-b-oss",m),M.addMessageHandler("vkn-b-gvt",h),M.addMessageHandler("vkn-b-gpms",i),M.addMessageHandler("vkn-b-spms",u),M.addMessageHandler("vkn-b-aath",w),M.addMessageHandler("vkn-b-gtet",y),M.addMessageHandler("vkn-b-rvk",p),M.addMessageHandler("vkn-b-ruc",v);const k=M,b=(e,s,t=!1)=>{try{sessionStorage.setItem(`vknext-storage-${e}`,s)}catch(a){if("QuotaExceededError"===a.name&&!t){for(const e in sessionStorage)e.startsWith("vknext-storage-"),e.startsWith("@METRICS_")&&sessionStorage.removeItem(e);return b(e,s,!0)}}},S=async(e,s,t)=>{try{b(e,JSON.stringify(s))}catch(e){console.error(e)}try{await a.set(e,s)}catch(e){console.error(e)}if(t)try{await a.set(`${e}_old`,t)}catch(e){console.error(e)}},f=["spyning","StorageMessages","VKNDeletedMessages","VKNExpiredMessages"];chrome.storage.local.get(["vknext","Themes"]).then(e=>{for(const s in e)S(s,e[s])}),chrome.storage.local.onChanged.addListener(async e=>{for(const s of Object.keys(e))f.includes(s)||(await S(s,e[s].newValue,e[s].oldValue),await k.sendMessage("vkn-b-ous",s))});const H=S;const x=window.s,_=/^\/s\/v\d+\/doc\/[\w-]+$|^\/doc\d+_\d+$/.test(location.pathname)&&!/^\/docs\/?$/.test(location.pathname);if(x&&document.documentElement instanceof HTMLHtmlElement&&!_)for(const s of x)try{e({src:chrome.runtime.getURL(s)})}catch(e){console.error(e)}})();