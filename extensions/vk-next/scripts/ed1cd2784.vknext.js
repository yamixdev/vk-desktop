"use strict";(globalThis.webpackChunkvknext=globalThis.webpackChunkvknext||[]).push([[2597],{25894:(t,e,o)=>{o.d(e,{R:()=>i});var a=o(63499),n=o(38651);const i=({audio:t,index:e})=>{let o=`${(0,n.A)(t)} - ${t.title}`;return t.subtitle&&(o+=` (${t.subtitle})`),"number"!=typeof e&&"string"!=typeof e||(o=`${e}. ${o}`),(0,a.A)(o.replaceAll("  "," ").trim())}},63499:(t,e,o)=>{o.d(e,{A:()=>n});const a=/\/|\\|:|\*|\?|"|<|>|\||\+|%|@|@\\0/g;function n(t){return t.replaceAll(a,"_")}},64299:(t,e,o)=>{o.d(e,{u:()=>n});var a=o(56260);const n=async t=>{if(t.signal?.aborted)return null;if(!t.audio?.url)return null;try{return await(0,a.G)(t)}catch(t){console.error("error download audio",t)}return null}},89150:(t,e,o)=>{o.d(e,{W:()=>a});var a=(0,o(78414).mT)("Icon20DownloadOutline","download_outline_20","0 0 20 20",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" id="download_outline_20"><g fill="currentColor"><path fill-rule="evenodd" d="M4 17.75a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H4.75a.75.75 0 0 1-.75-.75" clip-rule="evenodd" /><path d="M10.75 2.726c0-.401-.336-.726-.75-.726a.74.74 0 0 0-.75.726v9.722l-3.97-3.97a.75.75 0 0 0-1.06 1.06l5.245 5.246a.75.75 0 0 0 1.06 0l5.257-5.256a.75.75 0 0 0-1.061-1.061l-3.972 3.972z" /></g></symbol>',20,20,!1,void 0)},89210:(t,e,o)=>{o.d(e,{default:()=>k});var a=o(74848),n=o(89150),i=o(39107),l=o(96540),r=o(49032),s=o(37746),c=o(69926),d=o(7618),u=o(61054),w=o(93819),p=o(67078),m=o(43024),_=o(69128),f=o(25894),h=o(94037),v=o(89481),g=o(64299);const y=async t=>{const e=await w.A,a=await(0,v.A)({id:`chat_music_${t}`,startIn:"music"});await(0,p.A)({text:e.use("vkcom_downloading")});let n,i=`convo${t}`;try{if(d.z.isChatId(t)){const{items:e}=await window.vkApi.api("messages.getConversationsById",{peer_ids:t}),o=e[0]?.chat_settings;o?.title&&(i=o.title),n=o?.photo?.photo_50||o?.photo?.photo_100}else if(d.z.isUserId(t)){const[e]=await window.vkApi.api("users.get",{fields:"photo_100,is_nft",user_ids:t});e&&(i=`${e.first_name} ${e.last_name}`,n=e.photo_100)}}catch(t){console.error(t)}const l=`${i}.zip`,y=new AbortController,{signal:b}=y,k=new Date,A=`convo_music${t}`,{setProgress:x,startArchiving:$,finish:C,setExtraText:I}=(0,_.Hq)({id:A,title:a?i:l,type:"convo",onCancel:()=>y.abort(),photoUrl:n}),R=new c.A(r.pz);let U=1,z=0,T=0;const L=m.default.getValue("numTracksInPlaylist"),j=async(t,o)=>{try{const n=await(0,g.u)({audio:t,signal:b});if(!n)return;const l=(0,f.R)({audio:t,index:L?o:void 0}),r={name:`${l}.mp3`,lastModified:t.date?new Date(1e3*t.date):k,input:n};return b.aborted||(z++,x({current:z,total:T})),I(e.use("vkcom_playlist_track_download_completed",{trackName:l})),a?await(0,h.A)({zipFile:r,subFolderName:i,dirHandle:a}):r}catch(t){console.error(t)}};try{for await(const{items:e}of async function*(t){let e,o=!1;const a=await(0,u.V)();do{const n={media_type:"audio",peer_id:t,count:100};e&&(n.start_from=e);const i=await a.api("messages.getHistoryAttachments",n);if(e=i.next_from,yield i,0===i.items.length)return void(o=!0)}while(!1===o)}(t)){if(b.aborted)return;T+=e.length;for(const{attachment:t}of e){if(b.aborted)return;if("audio"!==t?.type)continue;const e=U++;R.addTask(()=>j(t.audio,e))}await R.waitAll()}}catch(t){console.error(t),await(0,p.A)({type:"warning",text:`VK Next (${l})`,subtitle:t.message})}const H=(await R.waitAll()).filter(t=>!!t);if(b.aborted)return;if(a)return I(e.use("vkcom_playlist_download_completed",{total:e.use("vkcom_tracks_plurals",z)})),await(0,p.A)({type:"done",text:e.use("vkcom_fs_music_done"),subtitle:i}),void C();I(""),$();const{downloadZip:K}=await o.e(1941).then(o.bind(o,71941)),N=await K(H).blob(),D=URL.createObjectURL(N),M=()=>(0,s.A)(D,l);await M(),C({onSave:M,onRemove:()=>URL.revokeObjectURL(D)}),I(e.use("vkcom_playlist_download_completed",{total:e.use("vkcom_tracks_plurals",z)}))},b="rGl0dyK7g91LaKUn",k=({peerId:t})=>{const[e,o]=(0,l.useState)(!1);return(0,a.jsx)(i.K0,{className:b,disabled:e,onClick:()=>{y(t).finally(()=>o(!1)).catch(console.error)},children:(0,a.jsx)(n.W,{})})}}}]);