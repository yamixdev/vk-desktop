"use strict";(globalThis.webpackChunkvknext=globalThis.webpackChunkvknext||[]).push([[459,3256],{25894:(t,e,n)=>{n.d(e,{R:()=>i});var o=n(63499),a=n(38651);const i=({audio:t,index:e})=>{let n=`${(0,a.A)(t)} - ${t.title}`;return t.subtitle&&(n+=` (${t.subtitle})`),"number"!=typeof e&&"string"!=typeof e||(n=`${e}. ${n}`),(0,o.A)(n.replaceAll("  "," ").trim())}},48229:(t,e,n)=>{n.d(e,{A:()=>c});var o=n(37746),a=n(88908),i=n(93819),s=n(67078),r=n(84896),l=n(15991);const c=async t=>{const[e,n,c]=t.split("_"),d=await(0,l.A)({owner_id:parseInt(e),playlist_id:parseInt(n),access_key:c,fixAudioUrl:!1}),u=await i.A;if(!d)return void await(0,s.A)({text:"Playlist not found",type:"error"});const _=(0,r.Z)(d);if(!_)return void await(0,s.A)({text:u.use("vkcom_playlist_cover_is_none"),type:"error"});const p=(d.main_artists||[]).map(t=>t.name),m=[];p.length&&m.push(`${p.join(", ")} - `),d.title?m.push(d.title):m.push("playlist"),(0,o.A)(_,(0,a.A)(m.join(""))+".jpg")}},51669:(t,e,n)=>{n.d(e,{e:()=>a});var o=n(50313);const a=()=>(0,o.A)("uiActionsMenu")},53644:(t,e,n)=>{n.d(e,{A:()=>a});let o=0;const a=t=>{const e=!!document.importNode;let n=(new DOMParser).parseFromString(t,"image/svg+xml").documentElement;e&&(n=document.importNode(n,!0));for(const t of n.querySelectorAll("title,desc"))t.remove();for(const t of n.querySelectorAll("[id]")){if(!t.id)continue;const e="vknext_icon-"+o++;let a=!1;for(const o of n.querySelectorAll(`[fill="url(#${t.id})"]`))o.setAttribute("fill",`url(#${e})`),a=!0;a&&(t.id=e)}return n}},62879:(t,e,n)=>{n.d(e,{A:()=>k});var o=n(49032),a=n(37746),i=n(69926),s=n(88908),r=n(93819),l=n(67078),c=n(43024),d=n(69128),u=n(25894),_=n(94037),p=n(89481),m=n(63499);const y=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),w="vknNewFolderCount",A=t=>{let e=(0,m.A)(t).replace(/[\r\n\t]/g," ").replace(/\s+/g," ");return e=e.trim().replace(/\.+$/,""),y.has(e.toUpperCase())&&(e=`${e}_safe`),e=e.substring(0,255),e||(()=>{try{const t=(Number(window.localStorage.getItem(w))||0)+1;return window.localStorage.setItem(w,String(t)),`folder (${t})`}catch(t){console.error(t)}return"folderMusic"})()};var v=n(84896),f=n(15991),h=n(64299);const k=async t=>{const e=await r.A;if(0===window.vk.id)return void(0,l.A)({text:e.use("vkcom_playlist_download_auth_required"),type:"error"});const m=await(0,p.A)({id:"playlist_music",startIn:"music"}),[y,w,k]=t.split("_");await(0,l.A)({text:e.use("vkcom_downloading")});const g=await(0,f.A)({owner_id:parseInt(y),playlist_id:parseInt(w),access_key:k,fixAudioUrl:!0});if(!g)return void await(0,l.A)({text:"Playlist not found",type:"error"});if(g?.error?.error_msg)return void await(0,l.A)({text:g.error.error_msg,type:"error"});if(!g.audios?.length)return void await(0,l.A)({text:e.use("vkcom_playlist_is_empty"),type:"error"});const x=new AbortController,{signal:P}=x,b=new Date,S=(g.main_artists||[]).map(t=>t.name),L=[];S.length&&L.push(`${S.join(", ")} - `),g.title?L.push(g.title):L.push("playlist");const C=A((0,s.A)(L.join(""))),j=`${C}.zip`,q=`playlist${t}`,{setProgress:T,startArchiving:M,finish:E,setExtraText:I}=(0,d.Hq)({id:q,title:m?C:`${(0,s.A)(L.join(""))}.zip`,type:"playlist",onCancel:()=>x.abort(),photoUrl:(0,v.Z)(g)||void 0}),N=new i.A(o.pz);let $=1,F=0;const O=g.audios.length;T({current:0,total:O});const R=c.default.getValue("numTracksInPlaylist"),B=async(t,n)=>{try{const o=await(0,h.u)({audio:t,playlist:g,signal:P});if(!o)return;const a=(0,u.R)({audio:t,index:R?n:void 0}),i={name:`${a}.mp3`,lastModified:t.date?new Date(1e3*t.date):b,input:o};return P.aborted||(F++,T({current:F,total:O})),I(e.use("vkcom_playlist_track_download_completed",{trackName:a})),m?await(0,_.A)({zipFile:i,subFolderName:C,dirHandle:m}):i}catch(t){console.error(t)}};for(const t of g.audios){const e=$++;N.addTask(()=>B(t,e))}const U=(await N.waitAll()).filter(t=>!!t);if(P.aborted)return;if(m)return I(e.use("vkcom_playlist_download_completed",{total:e.use("vkcom_tracks_plurals",F)})),await(0,l.A)({type:"done",text:e.use("vkcom_fs_music_playlist_done"),subtitle:C}),void E();I(""),M();const{downloadZip:H}=await n.e(1941).then(n.bind(n,71941)),W=await H(U).blob(),Z=URL.createObjectURL(W),V=()=>(0,a.A)(Z,j);await V(),E({onSave:V,onRemove:()=>URL.revokeObjectURL(Z)}),I(e.use("vkcom_playlist_download_completed",{total:e.use("vkcom_tracks_plurals",F)}))}},63499:(t,e,n)=>{n.d(e,{A:()=>a});const o=/\/|\\|:|\*|\?|"|<|>|\||\+|%|@|@\\0/g;function a(t){return t.replaceAll(o,"_")}},64299:(t,e,n)=>{n.d(e,{u:()=>a});var o=n(56260);const a=async t=>{if(t.signal?.aborted)return null;if(!t.audio?.url)return null;try{return await(0,o.G)(t)}catch(t){console.error("error download audio",t)}return null}},70459:(t,e,n)=>{n.d(e,{A:()=>o});const o={AudioPageMainTabBtn:"XYzoAKWs2KhH02Ye",AudioArtistHeaderActions:"v8VBorduCtZgTyyi",VideoPlayerDownloadIcon:"eaSw45y_1KLlo4Gw",SecondaryAttachment__afterItem:"RZ6NWD1WvjAOxG2Y",DownloadManagerPopup:"o9vy1XhnZrkvykUb",VideoPlayerHlsWarning__tooltip:"P9MhdlrtilEQt7Am",VideoPlayerHlsWarning__text:"Xq2PVks6OK6Z74Al",AudioPlaylistSnippet__actions:"FawmW4_Zd1R1BI1E",AudioPlaylistSnippet__actionButton:"ZPr5mXzL52VUPaRe",ActionButton__icon:"_5bFyslOmNjqqP7y",ActionButton__text:"o7YAH98fI9KVToa5",AudioPlayerUserControlsContainer__userButton:"e47qq1XqMPp6oTp7",AudioPlayerPlaybackButton:"wqb5e3cgYZFgHCc1",AudioRowReact__button:"q7d6KTdMjs6HYpKm",PrimaryButton:"Ovh62QE6FZgmlVq8"}},78105:(t,e,n)=>{n.d(e,{A:()=>_});var o=n(92046),a=n(79110),i=n(22707),s=n(51018),r=n(91570);const l=new s.e,c=t=>t.replace("audio_playlist","").replace("/","_");let d=!1;const u=async()=>{if(d)return;d=!0;const t=await(0,r.R)();t.onLocationChange(async()=>{const e=t.objLoc.z;e&&e.startsWith("audio_playlist")&&(await(0,o.c)(1e3),await(0,i.t)(),(t=>{const e=c(t);for(const t of l.listeners)t(e)})(e))})},_=t=>{const e=l.addListener(t);return(0,a.g)(()=>{const e=new URLSearchParams(window.location.search).get("z");e&&e.startsWith("audio_playlist")&&requestAnimationFrame(()=>t(c(e))),u()}),e}},88213:(t,e,n)=>{n.d(e,{A:()=>u});var o=n(92046),a=n(79110),i=n(22707),s=n(51018),r=n(91570);const l=new s.e;let c=!1;const d=async()=>{if(c)return;c=!0;(await(0,r.R)()).onLocationChange(async t=>{(t.startsWith("music/album")||t.startsWith("music/playlist"))&&(await(0,o.c)(1e3),await(0,i.t)(),(()=>{for(const t of l.listeners)t()})())})},u=t=>{const e=l.addListener(t);return(0,a.g)(()=>{(window.location.pathname.startsWith("/music/album")||window.location.pathname.startsWith("/music/playlist"))&&requestAnimationFrame(()=>t()),d()}),e}},88908:(t,e,n)=>{n.d(e,{A:()=>a});const o=document.createElement("textarea"),a=t=>(o.innerHTML=t,o.innerText)},94229:(t,e,n)=>{n.d(e,{A:()=>o});const o='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12.002 2a.9.9 0 0 1 .9.9v11.002l4.562-4.631a.9.9 0 1 1 1.283 1.263l-6.104 6.195a.9.9 0 0 1-1.284-.001l-6.09-6.206a.9.9 0 1 1 1.286-1.26l4.547 4.633V2.9a.9.9 0 0 1 .9-.9Zm-8 18.1a.9.9 0 0 1 .9-.9h14.2a.9.9 0 1 1 0 1.8h-14.2a.9.9 0 0 1-.9-.9Z" clip-rule="evenodd"/></svg>\n'},95963:(t,e,n)=>{n.r(e);var o=n(74848),a=n(53644),i=n(92046),s=n(94229),r=n(98570),l=n(51669),c=n(93819),d=n(67078),u=n(78105),_=n(88213),p=n(3068),m=n(51710),y=n(62879),w=n(48229),A=n(70459);const v=async()=>{const t=await(0,l.e)(),e=t.show;t.show=function(...t){try{(async t=>{if((0,r.A)()?.vms_installed)return;if(!t.classList.contains("audio_pl_snippet__action_btn"))return;const e=t.querySelector(".ui_actions_menu");if(!e||e.vkn_down_inj)return;e.vkn_down_inj=!0;const n=await c.A,o=document.createElement("div");o.className="ui_actions_menu_item",o.innerText=n.use("global_download"),o.addEventListener("click",async()=>{const e=t.closest(".audio_pl_snippet2");e?.dataset?.playlistId?await(0,y.A)(e.dataset.playlistId.replace("playlist_","")):await(0,d.A)({type:"error",text:"playlist id not found"})});const a=document.createElement("div");a.className="ui_actions_menu_item",a.innerText=n.use("vkcom_download_cover"),a.addEventListener("click",async()=>{const e=t.closest(".audio_pl_snippet2");e?.dataset?.playlistId?await(0,w.A)(e.dataset.playlistId.replace("playlist_","")):await(0,d.A)({type:"error",text:"playlist id not found"})}),e.prepend(o,a)})(t[0])}catch(t){console.error(t)}return Reflect.apply(e,this,t)}},f=async()=>{if((0,r.A)()?.vms_installed)return;const t=document.querySelector(".AudioPlaylistSnippet__actionButton .ActionsMenu__inner");if(!t)return void(async()=>{if((0,r.A)()?.vms_installed)return;const t=document.querySelector(".AudioPlaylistSnippet");if(!t)return;const{playlistId:e}=t.dataset;if(!e)return;const n=t.querySelector(".AudioPlaylistSnippet__header");if(!n||n.vkn_down_inj)return;n.vkn_down_inj=!0;const o=document.createElement("div");o.className=A.A.AudioPlaylistSnippet__actions;const i=document.createElement("button");i.className=A.A.AudioPlaylistSnippet__actionButton,i.addEventListener("click",()=>{(0,y.A)(e.replace("playlist_","")).catch(console.error)});const l=document.createElement("div");l.className=A.A.ActionButton__icon,l.appendChild((0,a.A)(s.A));const d=await c.A,u=document.createElement("span");u.className=A.A.ActionButton__text,u.innerText=d.use("vkcom_download_playlist"),i.append(l,u),o.appendChild(i),n.appendChild(o)})();if(t.vkn_down_inj)return;t.vkn_down_inj=!0;const e=await c.A,n=document.createElement("button");n.className="ActionsMenu__item",n.innerText=e.use("global_download"),n.addEventListener("click",async()=>{const e=(t=>{const e=t.closest(".AudioPlaylistSnippet");if(!e?.dataset?.playlistId)return null;let[n,o,a]=e.dataset.playlistId.replace("playlist_","").split("_");!a&&window.location.pathname.startsWith(`/music/playlist/${n}_${o}_`)&&(a=window.location.pathname.split("/music/playlist/")[1].split("_")[2]);const i=[n,o];return a&&i.push(a),i.join("_")})(t);e?await(0,y.A)(e):await(0,d.A)({type:"error",text:"playlist id not found"})}),t.prepend(n)},h=['[class*="AudioListHeader__actions--"]','[class*="AudioListBoxHeader__actions--"]','[class*="AudioListModalHeader__actions--"]'].join(","),k=async(t=0)=>{if((0,r.A)()?.vms_installed)return;if(t>10)throw new Error("[VK Next/audioPlaylist] Failed to inject");const e=document.getElementById("spa_root");if(!e)return;if(e.querySelector('[class*="Skeleton__skeleton"],[class*="SkeletonComponent__skeleton"]'))return await(0,i.c)(1e3),k(t+1);const a=e.querySelector(h);if(!a)return;if(a.vkn_down_inj)return;a.vkn_down_inj=!0;const{default:s}=await Promise.all([n.e(961),n.e(7397),n.e(1649),n.e(4682)]).then(n.bind(n,74682)),l=document.createElement("div");a.appendChild(l),await(0,p.A)({root:l,content:(0,o.jsx)(s,{})})},g=async(t,e=0)=>{if(!(0,r.A)()?.vms_installed){if(document.querySelector('.vkui__root .vkuiFlex [class*="Skeleton__skeleton"],.vkui__root .vkuiFlex__host [class*="Skeleton__skeleton"],.vkui__root .vkuiFlex__host [class*="SkeletonComponent__skeleton"]'))return await(0,i.c)(1e3),g(t,e+1);for(const e of document.querySelectorAll(h)){if(!e)return;if(e.vkn_down_inj)return;e.vkn_down_inj=!0;const a=e.querySelector(".vkuiFlex, .vkuiFlex__host"),{default:i}=await Promise.all([n.e(961),n.e(7397),n.e(1649),n.e(4682)]).then(n.bind(n,74682)),s=document.createElement("div");(a||e).appendChild(s),await(0,p.A)({root:s,content:(0,o.jsx)(i,{playlistFullId:t,isModal:!0})})}}};(0,m.A)()&&(v().catch(console.error),(0,_.A)(()=>{f().catch(console.error),k().catch(console.error)}),(0,u.A)(g))}}]);