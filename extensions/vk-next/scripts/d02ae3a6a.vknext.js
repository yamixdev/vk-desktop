(()=>{"use strict";const e=e=>{"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})},t=globalThis.location.host.split(".");let o;o="vk"!==t[0]?"vk.ru":`vk.${t[t.length-1]||"ru"}`;const n=o;(async()=>{if(window.location.hash.includes("#vknext=1"))return void e(()=>{const e=document.querySelector("form[method=\"post\"][action*='grant_access']");if(!e)return;const t=e.querySelector('input[type="submit"]');console.log(t),t?t.click():location.href=e.action});const t=new URLSearchParams(window.location.hash.slice(1)),o=t.get("state");if(o){const e=o.split(chrome.runtime.id)[1];if(e){const[,o,n]=e.split("_"),s=t.get("access_token"),a=(await chrome.storage.local.get("tokens"))?.tokens||{};a[o]={[n]:{token:s}},await chrome.storage.local.set({tokens:a}),window.close(),chrome.runtime.sendMessage({type:"sw_ct"})}}if("vknext_oauth"===window.name){const e=t.get("url");if(e)if(window.location.host===`login.${n}`){const t=document.createElement("iframe");t.style.display="none",t.name="vknext_oauth_get",t.src=e,document.documentElement.appendChild(t)}else if(window.location.host===`oauth.${n}`){const t=await fetch(e),o=await t.text();let n="";if(o){const e=o.match(/https.+act=grant_access.+html/);n=e&&e[0]?e[0]:t.url}else n=t.url;if(n){const e=new URL(n);e.searchParams.get("no_session")&&e.searchParams.delete("no_session");const t=e.href,o=document.createElement("iframe");return o.style.display="none",o.name="vknext_oauth_get",o.src=t,void document.documentElement.appendChild(o)}}return}"vknext_oauth_get"===window.name&&e(async()=>{const e=/https.+oauth\.vk[^%]+\d+/,t=document.documentElement.innerText.match(e)||window.location.href.match(e),o=document.querySelector("form[method=\"post\"][action*='grant_access']");if(o)location.href=o.action;else if(t){const e=t[0].replaceAll("&amp;","&"),o=new URLSearchParams(e.split("#")[1]),n=o.get("access_token"),s=parseInt(o.get("state")||""),a=parseInt(o.get("user_id")||""),c=(await chrome.storage.local.get("tokens"))?.tokens||{};c[a]={[s]:{token:n}},await chrome.storage.local.set({tokens:c}),window.close(),chrome.runtime.sendMessage({type:"sw_ct"})}})})().catch(console.error)})();