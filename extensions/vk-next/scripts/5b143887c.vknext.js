"use strict";(globalThis.webpackChunkvknext=globalThis.webpackChunkvknext||[]).push([[6091],{35584:(t,e,a)=>{a.d(e,{A:()=>n});const n=(t,e,a=null)=>{if(!Array.isArray(t)||0===t.length)return null;const n=[...t].sort((t,e)=>t.width<e.width?-1:t.width>e.width?1:t.height<e.height?-1:t.height>e.height?1:0),i=n.filter(t=>t.width>=e);if(0===i.length)return n[n.length-1];if(!a)return i[0];for(let t=0;t<i.length;t++){const e=i[t];if(e.height>=a)return e}const r=i.sort((t,e)=>e.height-t.height);return r[r.length-1]}},74732:(t,e,a)=>{a.d(e,{A:()=>s});var n=a(32106);const i=async(t,e)=>{const a=await(0,n._)({url:t,filename:e,type:"convertM3u8ToMp4"});return new File([a],e,{type:"video/mp4"})};var r=a(36008);const s=async(t,e)=>(await r.default.sendMessage("vkn-b-aath",new URL(t).origin+"/*"),await i(t,e))},76091:(t,e,a)=>{a.d(e,{default:()=>B});var n=a(37746),i=a(88908),r=a(93819),s=a(67078),o=a(69128),l=a(56260);const c=async t=>{const{audio:e,lastModified:a,signal:n,path:i}=t;if(n?.aborted)return null;if(!e.url)return null;const r={id:e.id,owner_id:e.ownerId,url:e.url,title:e.title,access_key:e.accessKey,artist:e.artist,album_id:e.albumId,album_part_number:e.albumPartNumber,duration:e.duration,subtitle:e.subtitle};try{const t=await(0,l.G)({audio:r,signal:n});return{name:`${i}${(()=>{if(e.title){let t=e.title;return e.subtitle&&(t+=` (${e.subtitle})`),e.artist&&(t+=` - ${e.artist}`),t}return`audio${e.ownerId}_${e.id}`})()}.mp3`,lastModified:a,input:t}}catch(t){return console.error(t),null}},d=async t=>{const{doc:e,lastModified:a,signal:n,path:i}=t;if(n?.aborted)return null;if(!e.url)return null;try{const t=new URL(e.url);"0"===t.searchParams.get("no_preview")&&t.searchParams.set("no_preview","1");let r=await fetch(t,{signal:n});const s=r.headers.get("content-type");if(s?.startsWith("text/html"))try{const t=await r.text(),e=t.match(/"docUrl":"(.*?)"/)?.[1];if(e){const t=new URL(e);t.searchParams.set("dl","1"),r=await fetch(t)}}catch(t){console.error(t)}const o=await r.arrayBuffer();return{name:`${i}${e.title?e.title:`doc${e.ownerId}_${e.id}.jpg`}`,lastModified:e.date?new Date(e.date):a,input:new Blob([o])}}catch(t){return console.error(t),null}},u=async t=>{const{graffiti:e,lastModified:a,signal:n,path:i}=t;if(n?.aborted)return null;if(!e.imageUrl)return null;try{const t=new URL(e.imageUrl),r=await fetch(t,{signal:n}),s=await r.arrayBuffer();return{name:`${i}${t.pathname.slice(1)}.jpg`,lastModified:a,input:new Blob([s])}}catch(t){return console.error(t),null}};var f=a(35584);const p=async t=>{const{miniApp:e,lastModified:a,signal:n,message:i,path:r}=t;if(n?.aborted)return null;const s=e?.images;if(!s)return null;const o=(0,f.A)(s,512)?.url;if(!o)return null;try{const t=await fetch(o,{signal:n}),s=await t.arrayBuffer(),l=e.title?e.title:`miniapp${e.id}`,c=i.updatedAt?i.updatedAt:i.sentAt;return{name:`${r}${l}.jpg`,lastModified:c?new Date(c):a,input:new Blob([s])}}catch(t){return console.error(t),null}},h=async t=>{const{miniAppWidget:e,lastModified:a,signal:n,message:i,path:r}=t;if(n?.aborted)return null;const s=e?.app;if(!s)return null;const o=s.icon576||s.icon278||s.icon240||s.icon160||s.icon150||s.icon139||s.icon80||s.icon75;if(!o)return null;try{const t=await fetch(o,{signal:n}),e=await t.arrayBuffer(),l=s.title?s.title:`miniappWidget${s.id}`,c=i.updatedAt?i.updatedAt:i.sentAt;return{name:`${r}${l}.jpg`,lastModified:c?new Date(c):a,input:new Blob([e])}}catch(t){return console.error(t),null}};var g=a(92046);const w=async t=>{const{photo:e,lastModified:a,signal:n,path:i}=t;if(n?.aborted)return null;if(!e.originalImage)return null;try{const t=await fetch(e.originalImage,{signal:n}),r=await t.arrayBuffer();return{name:`${i}${[e.ownerId,e.id].join("_")}.jpg`,lastModified:e.uploadDate?new Date(e.uploadDate):a,input:new Blob([r])}}catch(e){return console.error(e),await(0,g.c)(1e3),await w(t)}},m=w,b=async t=>{const{poll:e,lastModified:a,signal:n,message:i,path:r}=t;if(n?.aborted)return null;const s=e?.backgroundPhoto?.image;if(!s)return null;const o=(0,f.A)(s,2e5)?.url;if(!o)return null;try{const t=await fetch(o,{signal:n}),s=await t.arrayBuffer(),l=e.title?`${e.title}.jpg`:`poll${e.ownerId}_${e.id}.jpg`,c=i.updatedAt?i.updatedAt:i.sentAt;return{name:`${r}${l}`,lastModified:c?new Date(c):a,input:new Blob([s])}}catch(t){return console.error(t),null}},$=async t=>{const{sticker:e,lastModified:a,signal:n,message:i,path:r,isDark:s=!1}=t;if(n?.aborted)return null;const o=s?e?.item?.images_with_background:e?.item?.images;if(!o)return null;const l=(0,f.A)(o,512)?.url;if(!l)return null;try{const t=await fetch(l,{signal:n}),o=await t.arrayBuffer(),c=`sticker${e.id?e.id:s?"_":""}${s?"b":""}.png`,d=i.updatedAt?i.updatedAt:i.sentAt;return{name:`${r}${c}`,lastModified:d?new Date(d):a,input:new Blob([o])}}catch(t){return console.error(t),null}},y=async t=>{const{stickerPack:e,lastModified:a,signal:n,message:i,path:r}=t;if(n?.aborted)return null;const s=e?.iconUrl;if(!s)return null;try{const t=await fetch(s,{signal:n}),o=await t.arrayBuffer(),l=`${e.title}_${e.packId}.png`,c=i.updatedAt?i.updatedAt:i.sentAt;return{name:`${r}${l}`,lastModified:c?new Date(c):a,input:new Blob([o])}}catch(t){return console.error(t),null}};var M=a(74732),A=a(99761);const k=async t=>{const{video:e,lastModified:a,signal:n,path:r}=t;if(n?.aborted)return null;if(e.files?.external)return null;const[s,o]=(0,A.A)(e.files),l=e.files.hls,c=s&&o>=240||s&&!l?s:l||null;if(!c)return null;const d=(0,i.A)(e.title?`${e.title}.mp4`:`video${e.ownerId}_${e.id}.mp4`);let u=!1;try{if(c===l)try{const t=await(0,M.A)(c,d);return{name:`${r}${d}`,lastModified:e.uploadDate?new Date(e.uploadDate):a,input:t}}catch(t){u=!0,console.error(t)}if(!s)return null;const t=await fetch(u?s:c,{signal:n}),i=await t.arrayBuffer();return{name:`${r}${d}`,lastModified:e.uploadDate?new Date(e.uploadDate):a,input:new Blob([i])}}catch(t){return console.error(t),null}},v=async t=>{const{voice:e,lastModified:a,signal:n,message:i,path:r}=t;if(n?.aborted)return null;const s=e.linkMp3||e.linkOgg,o=!!e.linkMp3;if(!s)return null;try{const t=await fetch(s,{signal:n}),l=await t.arrayBuffer(),c=`voice${e.ownerId}_${e.id}${o?".mp3":".ogg"}`,d=i.updatedAt?i.updatedAt:i.sentAt;return{name:`${r}${c}`,lastModified:d?new Date(d):a,input:new Blob([l])}}catch(t){return console.error(t),null}},_=async({message:t,attaches:e,signal:a,lastModified:n,path:i="",onUpdateProgress:r,onUpdateTotal:s})=>{let o=[];for(const l of Object.values(e)){let e=l;for(const l of Array.isArray(e)?e:[e])if(l){switch(l.kind){case"Photo":o.push(m({photo:l,signal:a,lastModified:n,path:i}));break;case"VideoMessage":case"Video":o.push(k({video:l,signal:a,lastModified:n,path:i}));break;case"Doc":o.push(d({doc:l,signal:a,lastModified:n,path:i}));break;case"Poll":o.push(b({poll:l,signal:a,lastModified:n,message:t,path:i}));break;case"Audio":o.push(c({audio:l,signal:a,lastModified:n,path:i}));break;case"Graffiti":o.push(u({graffiti:l,signal:a,lastModified:n,path:i}));break;case"WallReply":{const e=await _({message:t,attaches:l.attaches,signal:a,lastModified:n,path:`${i}wallReply${l.ownerId}_${l.postId}_r${l.id}/`,onUpdateProgress:r,onUpdateTotal:s});o=o.concat(e);break}case"Wall":{const e=await _({message:t,attaches:l.attaches,signal:a,lastModified:n,path:`${i}wall${l.ownerId}_${l.id}/`,onUpdateProgress:r,onUpdateTotal:s});o=o.concat(e);break}case"StickerPack":o.push(y({message:t,stickerPack:l,signal:a,lastModified:n,path:i}));break;case"Sticker":o.push($({message:t,sticker:l,signal:a,lastModified:n,path:i,isDark:!1}),$({message:t,sticker:l,signal:a,lastModified:n,path:i,isDark:!0}));break;case"Voice":o.push(v({message:t,voice:l,signal:a,lastModified:n,path:i}));break;case"MiniApp":o.push(p({message:t,miniApp:l,signal:a,lastModified:n,path:i}));break;case"MiniAppWidget":o.push(h({message:t,miniAppWidget:l,signal:a,lastModified:n,path:i}));break;default:console.warn("[downloadMessageAttaches] unknown kind",{value:l})}for(const t of o)t.then(()=>r(1));if(s(o.length),o.length%20==0)try{await Promise.all(o)}catch(t){console.error(t)}}else console.warn("[downloadMessageAttaches] value is undefined",{message:t,value:l})}return o},U=_,B=async t=>{const e=new AbortController,{signal:l}=e,c=new Date,d=await r.A,u=(0,i.A)(`${t.peerId}_${t.cmid}.zip`),{setProgress:f,startArchiving:p,finish:h,setExtraText:g,cancel:w,setTitle:m}=(0,o.Hq)({id:`message${t.peerId}_${t.cmid}`,title:u,type:"message_attach",onCancel:()=>e.abort()});let b=[],$=0,y=0;const M=t=>{y+=t,f({current:$,total:y})},A=t=>{$+=t,f({current:$,total:y})};if(t.attaches)try{b=await U({message:t,attaches:t.attaches,signal:l,lastModified:c,onUpdateTotal:M,onUpdateProgress:A})}catch(t){console.error(t)}for(const e of t.forwardedMessages||[])try{const t=await U({message:e,attaches:e.attaches,signal:l,lastModified:c,onUpdateTotal:M,onUpdateProgress:A});b=b.concat(t)}catch(t){console.error(t)}const k=(await Promise.all(b)).filter(Boolean);if(l.aborted)return;if(0===k.length)return w(),void await(0,s.A)({type:"error",text:d.use("global_not_found")});if(1===k.length){const t=k[0],e=URL.createObjectURL(t.input);m(t.name);const a=()=>(0,n.A)(e,t.name),i=()=>URL.revokeObjectURL(e);return await a(),h({onSave:a,onRemove:i}),void g("")}p();const{downloadZip:v}=await a.e(1941).then(a.bind(a,71941)),_=await v(k).blob(),B=URL.createObjectURL(_),D=()=>(0,n.A)(B,u);await D(),h({onSave:D,onRemove:()=>URL.revokeObjectURL(B)}),g("")}},88908:(t,e,a)=>{a.d(e,{A:()=>i});const n=document.createElement("textarea"),i=t=>(n.innerHTML=t,n.innerText)},99761:(t,e,a)=>{a.d(e,{A:()=>n});const n=t=>{const e=Object.keys(t).filter(t=>t.startsWith("mp4_"));e.sort((t,e)=>{const a=parseInt(t.split("_")[1]);return parseInt(e.split("_")[1])-a});for(const a of e)if(t[a])return[t[a],Number(a.split("_")[1])];return[null,null]}}}]);