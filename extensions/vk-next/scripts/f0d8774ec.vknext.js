"use strict";(globalThis.webpackChunkvknext=globalThis.webpackChunkvknext||[]).push([[459,8043],{4760:(t,e,o)=>{o.d(e,{Q:()=>n});const n=(t,e=100)=>{const o=[...t],n=[];for(;o.length;)n.push(o.splice(0,e||o.length));return n}},25894:(t,e,o)=>{o.d(e,{R:()=>i});var n=o(63499),a=o(38651);const i=({audio:t,index:e})=>{let o=`${(0,a.A)(t)} - ${t.title}`;return t.subtitle&&(o+=` (${t.subtitle})`),"number"!=typeof e&&"string"!=typeof e||(o=`${e}. ${o}`),(0,n.A)(o.replaceAll("  "," ").trim())}},25915:(t,e,o)=>{o.d(e,{A:()=>n});const n=(t,e,o)=>{if(!(e in t))throw console.warn("[VK Next objectHook]:",t,t[e]),new Error(`[VK Next objectHook]: object "${String(e)}" not found`);let n=t[e];try{o(n)}catch(t){console.error(t)}return Object.defineProperty(t,e,{get:()=>n,set(t){n=t;try{o(n)}catch(t){console.error(t)}return n}}),{remove:()=>{delete t[e],t[e]=n}}}},53644:(t,e,o)=>{o.d(e,{A:()=>a});let n=0;const a=t=>{const e=!!document.importNode;let o=(new DOMParser).parseFromString(t,"image/svg+xml").documentElement;e&&(o=document.importNode(o,!0));for(const t of o.querySelectorAll("title,desc"))t.remove();for(const t of o.querySelectorAll("[id]")){if(!t.id)continue;const e="vknext_icon-"+n++;let a=!1;for(const n of o.querySelectorAll(`[fill="url(#${t.id})"]`))n.setAttribute("fill",`url(#${e})`),a=!0;a&&(t.id=e)}return o}},56992:(t,e,o)=>{o.d(e,{X:()=>a});var n=o(50313);const a=()=>(0,n.A)("AudioUtils")},63499:(t,e,o)=>{o.d(e,{A:()=>a});const n=/\/|\\|:|\*|\?|"|<|>|\||\+|%|@|@\\0/g;function a(t){return t.replaceAll(n,"_")}},64299:(t,e,o)=>{o.d(e,{u:()=>a});var n=o(56260);const a=async t=>{if(t.signal?.aborted)return null;if(!t.audio?.url)return null;try{return await(0,n.G)(t)}catch(t){console.error("error download audio",t)}return null}},70459:(t,e,o)=>{o.d(e,{A:()=>n});const n={AudioPageMainTabBtn:"XYzoAKWs2KhH02Ye",AudioArtistHeaderActions:"v8VBorduCtZgTyyi",VideoPlayerDownloadIcon:"eaSw45y_1KLlo4Gw",SecondaryAttachment__afterItem:"RZ6NWD1WvjAOxG2Y",DownloadManagerPopup:"o9vy1XhnZrkvykUb",VideoPlayerHlsWarning__tooltip:"P9MhdlrtilEQt7Am",VideoPlayerHlsWarning__text:"Xq2PVks6OK6Z74Al",AudioPlaylistSnippet__actions:"FawmW4_Zd1R1BI1E",AudioPlaylistSnippet__actionButton:"ZPr5mXzL52VUPaRe",ActionButton__icon:"_5bFyslOmNjqqP7y",ActionButton__text:"o7YAH98fI9KVToa5",AudioPlayerUserControlsContainer__userButton:"e47qq1XqMPp6oTp7",AudioPlayerPlaybackButton:"wqb5e3cgYZFgHCc1",AudioRowReact__button:"q7d6KTdMjs6HYpKm",PrimaryButton:"Ovh62QE6FZgmlVq8"}},74792:(t,e,o)=>{var n=o(74848),a=o(53644),i=o(94229),r=o(98570),s=o(38729),l=o(25915),c=o(7417),d=o(51018),u=o(91570),m=o(56992);const w=new d.e,_=t=>{for(const e of w.listeners)e(t)},p=()=>{for(const t of document.querySelectorAll(".AudioPlayerBlock__root"))_(t)};let A=!1;const f=t=>{const e=w.addListener(t);return(0,c.n)(p),A||(A=!0,(0,u.R)().then(t=>{t.onLocationChange(t=>{t.startsWith("audio")&&p()}),(async()=>{const t=(await(0,m.X)()).getLayer();t._initSection||(t._initSection=void 0),(0,l.A)(t,"_initSection",p)})().catch(console.error)})),e};var y=o(93819),h=o(88213),v=o(3068),b=o(92046);const g=async(t,e=0)=>{if(5===e)throw new Error("[audio hooks] users controls not found");const o=t.querySelector('[class*="AudioPlayerUserControlsContainer__userButtonsContainer--"]');return o||(await(0,b.c)(1e3),g(t,e+1))},k=g;var P=o(49032),x=o(37746),C=o(69926),B=o(4760),q=o(67078),S=o(43024),E=o(69128),T=o(25894),L=o(94037),$=o(89481),j=o(64299);const R=async t=>{const e=await y.A;if(0===window.vk.id)return void(0,q.A)({text:e.use("vkcom_playlist_download_auth_required"),type:"error"});const n=await(0,$.A)({id:`user_music_${t}`,startIn:"music"});await(0,q.A)({text:e.use("vkcom_downloading")});let a,i=`audios${t}`;try{const[e]=await window.vkApi.api("users.get",{fields:"photo_100,is_nft",user_ids:t});e&&(i=`${e.first_name} ${e.last_name}`,a=e.photo_100)}catch(t){console.error(t)}const r=`${i}.zip`,s=new AbortController,{signal:l}=s,c=new Date,d=`music${t}`,{setProgress:u,startArchiving:m,finish:w,setExtraText:_}=(0,E.Hq)({id:d,title:n?i:r,type:"owner_music",onCancel:()=>s.abort(),photoUrl:a}),p=new C.A(P.pz);let A=1,f=0,h=0;const v=S.default.getValue("numTracksInPlaylist"),b=async(t,o)=>{try{const a=await(0,j.u)({audio:t,signal:l});if(!a)return;const r=(0,T.R)({audio:t,index:v?o:void 0}),s={name:`${r}.mp3`,lastModified:t.date?new Date(1e3*t.date):c,input:a};return l.aborted||(f++,u({current:f,total:h})),_(e.use("vkcom_playlist_track_download_completed",{trackName:r})),n?await(0,L.A)({zipFile:s,subFolderName:i,dirHandle:n}):s}catch(t){console.error(t)}};try{const e=await(async t=>{const{audios:e}=await vkApi.api("audio.getAudioIdsBySource",{source:"playlist",entity_id:`${t}_-1`}),o=[];for(const t of(0,B.Q)(e,100)){const e=vkApi.api("audio.getById",{audios:t.map(t=>t.audio_id).join(",")});o.push(e),o.length%10==0&&await Promise.all(o)}return(await Promise.all(o)).flat()})(t);if(h=e.length,l.aborted)return;for(const t of e){const e=A++;p.addTask(()=>b(t,e))}await p.waitAll()}catch(t){console.error(t),await(0,q.A)({text:t.message,type:"error"})}const g=(await p.waitAll()).filter(t=>!!t);if(l.aborted)return;if(n)return _(e.use("vkcom_playlist_download_completed",{total:e.use("vkcom_tracks_plurals",f)})),await(0,q.A)({type:"done",text:e.use("vkcom_fs_music_done"),subtitle:i}),void w();_(""),m();const{downloadZip:k}=await o.e(1941).then(o.bind(o,71941)),R=await k(g).blob(),N=URL.createObjectURL(R),U=()=>(0,x.A)(N,r);await U(),w({onSave:U,onRemove:()=>URL.revokeObjectURL(N)}),_(e.use("vkcom_playlist_download_completed",{total:e.use("vkcom_tracks_plurals",f)}))};var N=o(70459);const U=(0,s.sr)(),Z=(0,s.sr)(),F=async t=>{if(t.vkn_down_inj)return;t.vkn_down_inj=!0;const e=await y.A,s=(0,r.A)(),l=document.getElementsByClassName("audio_section_tabs_actions");for(const t of l){if(s?.vms_installed)continue;if(t.getElementsByClassName(N.A.AudioPageMainTabBtn).length)continue;const o=document.createElement("button");o.className=N.A.AudioPageMainTabBtn,o.addEventListener("click",()=>R(window.cur.oid||window.vk.id).catch(console.error)),o.addEventListener("mouseover",function(){window.showTooltip(this,{text:e.use("vkcom_download_all_music"),black:1,noZIndex:!0,needLeft:!0,shift:[5,2]})}),o.appendChild((0,a.A)(i.A)),t.prepend(o)}if(0===l.length&&!s?.vms_installed){const t=document.querySelector(".audio_page_content_block_wrap .page_block_h2 .page_block_header_extra");if(t){const o=document.createElement("button");o.className=N.A.AudioPageMainTabBtn,o.addEventListener("click",()=>R(window.cur.oid||window.vk.id).catch(console.error)),o.addEventListener("mouseover",function(){window.showTooltip(this,{text:e.use("vkcom_download_all_music"),black:1,noZIndex:!0,needLeft:!0,shift:[5,2]})}),o.appendChild((0,a.A)(i.A)),t.appendChild(o)}}const c=await k(t);if(c){if(!s?.vms_installed&&!c.querySelector(`#${Z}`)){const t=document.createElement("div");t.id=Z,t.className=N.A.AudioPlayerUserControlsContainer__userButton,c.prepend(t);const{default:e}=await Promise.all([o.e(961),o.e(7397),o.e(1649),o.e(8414),o.e(150),o.e(695)]).then(o.bind(o,50150));await(0,v.A)({root:t,content:(0,n.jsx)(e,{type:"audio_page",getAudioObject:()=>window.AudioUtils.audioTupleToAudioObject(window.ap.getCurrentAudio()),tooltipProps:{placement:"bottom",appearance:"black",enableInteractive:!0}}),disableAppRoot:!0,disableConfig:!0,disableParentTransformForPositionFixedElements:!0})}if(!s?.vms_installed&&!c.querySelector(`#${U}`)){const t=document.createElement("div");t.id=U,t.className=N.A.AudioPlayerUserControlsContainer__userButton,c.prepend(t);const{default:e}=await Promise.all([o.e(961),o.e(7397),o.e(1649),o.e(8414),o.e(150),o.e(8661)]).then(o.bind(o,16135));await(0,v.A)({root:t,content:(0,n.jsx)(e,{}),disableAppRoot:!0,disableConfig:!0,disableParentTransformForPositionFixedElements:!0})}}};f(F),(0,h.A)(()=>{for(const t of document.querySelectorAll('[data-testid="audioplayerblocksectionslayout"],[class*="AudioPlayerBlockSectionsLayout__root"]'))F(t)})},88213:(t,e,o)=>{o.d(e,{A:()=>u});var n=o(92046),a=o(79110),i=o(22707),r=o(51018),s=o(91570);const l=new r.e;let c=!1;const d=async()=>{if(c)return;c=!0;(await(0,s.R)()).onLocationChange(async t=>{(t.startsWith("music/album")||t.startsWith("music/playlist"))&&(await(0,n.c)(1e3),await(0,i.t)(),(()=>{for(const t of l.listeners)t()})())})},u=t=>{const e=l.addListener(t);return(0,a.g)(()=>{(window.location.pathname.startsWith("/music/album")||window.location.pathname.startsWith("/music/playlist"))&&requestAnimationFrame(()=>t()),d()}),e}},94229:(t,e,o)=>{o.d(e,{A:()=>n});const n='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12.002 2a.9.9 0 0 1 .9.9v11.002l4.562-4.631a.9.9 0 1 1 1.283 1.263l-6.104 6.195a.9.9 0 0 1-1.284-.001l-6.09-6.206a.9.9 0 1 1 1.286-1.26l4.547 4.633V2.9a.9.9 0 0 1 .9-.9Zm-8 18.1a.9.9 0 0 1 .9-.9h14.2a.9.9 0 1 1 0 1.8h-14.2a.9.9 0 0 1-.9-.9Z" clip-rule="evenodd"/></svg>\n'}}]);