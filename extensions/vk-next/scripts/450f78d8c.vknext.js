"use strict";(globalThis.webpackChunkvknext=globalThis.webpackChunkvknext||[]).push([[6542],{6542:(e,t,o)=>{o.d(t,{default:()=>w});var r=o(82295),n=o(92046),a=o(96815),s=o(26312);class c extends Error{constructor({error_info:e}){super(e),Object.setPrototypeOf(this,c.prototype)}}const i=new Map,l=async(e=6287487,t=!1)=>{const o=i.get(e);if(o&&!t)return o;const w=s.A[e];if(!w)throw new Error(`хранилище для ${e} не найдено`);const u=new Promise(async(o,s)=>{try{const u=t?"":(await a.storage.local.get(w))[w]||"";let d=0;const h=10,p=2e3;let f=new Response(JSON.stringify({error_code:408}),{status:408});const k=()=>d>=1?"vk.ru":r.A;for(;d<h;){const t=new AbortController,o=setTimeout(()=>t.abort(),0===d?2e3:15e3);try{f=await fetch(`https://login.${k()}/?act=web_token`,{headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({version:"1",app_id:e.toString(),access_token:u}),method:"POST",credentials:"include",signal:t.signal});try{console.log("[VK API]: Web Token",{response:f})}catch(e){console.error(e)}if(f.ok)break}catch(e){console.error(e),await(0,n.c)(p)}clearTimeout(o),d++}const y=await f.json();try{console.log("[VK API]: Web Token",{response:f,data:y})}catch(e){console.error(e)}if("okay"===y.type){const{access_token:t,user_id:r}=y.data;return t!==u&&await a.storage.local.set({[w]:t}),i.delete(e),o({access_token:t,user_id:r})}if("unauthorized"===y.error_info){await(0,n.c)(3e3);const t=await l(e,!0);return i.delete(e),o(t)}if("wrong origin"===y.error_info&&!t){await(0,n.c)(1e3);try{const t=await l(e,!0);return i.delete(e),o(t)}catch(e){s(new c(e))}}s(new c(y))}catch(t){if(console.error(t),"TypeError"===t.name)try{await(0,n.c)(2e3);const t=await l(e,!0);return i.delete(e),o(t)}catch(e){s(e)}s(t)}});return i.set(e,u),u},w=l}}]);