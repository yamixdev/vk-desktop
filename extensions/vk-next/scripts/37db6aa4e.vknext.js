"use strict";(globalThis.webpackChunkvknext=globalThis.webpackChunkvknext||[]).push([[8192],{2921:(t,e,s)=>{s.d(e,{A:()=>n});const r=new Map,a=t=>t.trim().toLowerCase().replaceAll("ё","е").replaceAll("&amp;","&"),n=async({title:t,mainArtists:e,featuredArtists:s,performer:n,signal:o})=>{const i=((t,e,s=[])=>{const r=a(t)+" "+e.map(t=>a(t.name)).concat(s).join(" ");return a(r)})(t,n?[{name:n}]:"string"==typeof e?[{name:e}]:e,s);if(r.has(i))return r.get(i);let l;try{const t=await fetch("https://api.genius.com/search?"+new URLSearchParams({q:i}),{signal:o});if(200!==t.status)return"";l=await t.json()}catch(t){return console.error("Error fetching search results:",t),""}const c=l?.response?.hits||[];let u=c.find(e=>a(e?.result?.title)===a(t));if(!u){const t=[],e=c.filter(e=>{if(e?.result?.title){const s=a(e.result.full_title||[e.result.title,e.result.artist_names].filter(t=>t).join(" ")),r=i.split(" ").filter(t=>!s.includes(t)).length,n=r<3;return n&&t.push(r),n}return!1});let s=4;for(const[r,a]of Object.entries(t))s>a&&(s=a,u=e[r])}if(!u)return r.set(i,""),"";const d=u.result?.id;if(!d)return r.set(i,""),"";try{l=await fetch(`https://api.genius.com/songs/${d}?text_format=plain`,{signal:o}),l=await l.json()}catch(t){return console.error("Error fetching song details:",t),""}const p=l?.response?.song?.lyrics?.plain?.trim()||"";return r.set(i,p),p}},15991:(t,e,s)=>{s.d(e,{A:()=>i});var r=s(97992),a=s(91953),n=s(61054);const o=async t=>{const e=await(0,n.V)();try{const{playlist:s}=await e.api("audio.getPlaylistById",{playlist_id:t.playlist_id,owner_id:t.owner_id,access_key:t.access_key,extra_fields:"owner, duration"});return s.photo&&(s.coverUrl_l=(t=>{let e,s=0;for(const[r,a]of Object.entries(t))if(r.startsWith("photo_")){const t=parseInt(r.split("photo_")[1],10);t>s&&(s=t,e=a)}return e})(s.photo)),s}catch(t){console.error(t)}try{const s=await(0,a._)(),[r]=await s.promisifiedPost("/al_audio.php?act=load_section",{access_hash:t.access_key||"",al:"1",claim:"0",is_loading_all:"0",is_preload:"0",offset:"0",owner_id:t.owner_id,playlist_id:t.playlist_id,type:"playlist"});if(!r)return null;if(0===window.vk.id)return null;const n=await e.api("audio.get",{owner_id:r.ownerId,playlist_id:r.id,access_key:t.access_key,count:1e4});return{id:r.id,owner_id:r.ownerId,title:r.title,description:r.rawDescription,type:0,count:r.totalCount||r.list?.length||0,followers:0,no_discover:Boolean(r.noDiscover),plays:0,create_time:r.lastUpdated,update_time:r.lastUpdated,audios:n.items,subtitle:`${r.subTitle||""}`,main_artists:r.authorName.split(",").map(t=>({name:t.trim()})),coverUrl_l:r.coverUrl}}catch(t){console.error(t)}return null},i=async t=>{const e=await o(t);if(!e)return null;try{const t=[e.owner_id,e.id];e.access_key&&t.push(e.access_key);const{audios:s}=await vkApi.api("audio.getAudioIdsBySource",{source:"playlist",entity_id:t.join("_")}),a=[];for(const t of(0,r.A)(s,100)){const e=vkApi.api("audio.getById",{audios:t.map(t=>t.audio_id).join(",")});a.push(e),a.length%10==0&&await Promise.all(a)}e.audios=(await Promise.all(a)).flat()}catch(t){console.error(t)}return e}},24293:(t,e,s)=>{var r,a;s.d(e,{h:()=>r}),(a=r||(r={})).PREPARING="preparing",a.DOWNLOADING="downloading",a.FINISHED="finished",a.ARCHIVING="archiving"},37746:(t,e,s)=>{s.d(e,{A:()=>n});const r=t=>{try{t.dispatchEvent(new MouseEvent("click"))}catch(e){const s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(s)}},a=async(t,e="download")=>{const s=document.createElement("a");s.download=e,s.rel="noopener",(globalThis?.chrome?.runtime?.id||globalThis?.browser?.runtime?.id)&&(s.target="_blank"),"string"==typeof t?(s.href=t,s.origin!==location.origin?await(async t=>{try{const e=await globalThis.fetch(t,{method:"HEAD"});return e.status>=200&&e.status<=299}catch(t){console.error(t)}return!1})(s.href)?await(async(t,e)=>{try{const s=await globalThis.fetch(t,{method:"GET"}),r=await s.blob();await a(r,e)}catch(t){console.error(t)}})(t,e):(s.target="_blank",r(s)):r(s)):(s.href=URL.createObjectURL(t),setTimeout(()=>{URL.revokeObjectURL(s.href)},4e4),setTimeout(()=>{r(s)},0))},n=a},38651:(t,e,s)=>{s.d(e,{A:()=>a});const r=(t=[])=>t.map(t=>t.name).join(", "),a=t=>{let e=t.performer||t.artist;if(!e){const s=r(t.main_artists||t.mainArtists),a=r(t.featured_artists||t.featArtists);e=s,a&&(e+=` feat. ${a}`)}return e}},42791:(t,e,s)=>{s.d(e,{A:()=>r});const r=t=>{if(t.album&&!Array.isArray(t.album)){const e=t.album;return e?.access_key?[e.owner_id,e.id,e.access_key]:[e.owner_id,e.id]}return t.album?t.album:[]}},56260:(t,e,s)=>{s.d(e,{G:()=>g});var r=s(68909),a=s(8596),n=s(82295);const o=t=>new Promise((e,s)=>{const r=new FileReader;r.onload=t=>{t.target&&t.target.result instanceof ArrayBuffer?e(t.target.result):s(new Error("Invalid result"))},r.onerror=t=>{s(t)},r.readAsArrayBuffer(t)});var i=s(89141),l=s(67078),c=s(2921),u=s(43024);const d=t=>{if(!t)return"";const e=new Date(1e3*t);return`${String(e.getUTCDate()).padStart(2,"0")}${String(e.getUTCMonth()+1).padStart(2,"0")}`};var p=s(42791),m=s(84896),f=s(38651),h=s(15991);const w={1:"Rock",2:"Pop",3:"Rap & Hip-Hop",4:"Easy Listening",5:"Dance & House",6:"Instrumental",7:"Metal",21:"Alternative",8:"Dubstep",1001:"Jazz & Blues",10:"Drum & Bass",11:"Trance",12:"Chanson",13:"Ethnic",14:"Acoustic & Vocal",15:"Reggae",16:"Classical",17:"Indie Pop",18:"Other",19:"Speech",22:"Electropop & Disco"},g=async({audio:t,playlist:e,signal:s,onProgress:g})=>{if(!t.url)throw await(0,l.A)({text:"Audio URL not found",type:"error"}),console.error("Audio URL not found",t),new Error("Audio URL not found");const _=await(0,r.H)({url:(0,i.audioUnmaskSource)(t.url),onProgress(t){g&&g(Math.round(100*t),100)},forceHls:"hlsjs"===u.default.getValue("audioConvertMethod")});if(!u.default.getValue("id3"))return _;if(!e){const[s,r,a]=(0,p.A)(t);s&&r&&(e=await(0,h.A)({owner_id:s,playlist_id:r,access_key:a}))}const y=(0,m.A)(t);try{const r=new a.Q(await o(_));if(r.setFrame("COMM",{description:"vknext.net",text:"Трек скачан из ВКонтакте через VK Next: https://vknext.net",language:"rus"}),null!==y&&r.setFrame("APIC",{type:3,data:await y,description:"vknext.net",useUnicodeEncoding:!0}),t.title){let e=t.title;(t.subTitle||t.subtitle)&&(e+=`(${t.subTitle||t.subtitle})`),r.setFrame("TIT2",e)}(t.subTitle||t.subtitle)&&r.setFrame("TIT3",t.subTitle||t.subtitle),r.setFrame("TLEN",1e3*t.duration);const i=t.main_artists||t.mainArtists||[];if(t.featured_artists?i.push(...t.featured_artists):t.featArtists&&i.push({name:t.featArtists}),!i.length){let e=t.performer||t.artist;if(e)for(const t of e.split(","))i.push({name:t.trim()})}let l=null;if(i.length){l=i.map(t=>t.name)||[];const t=i.find(t=>!!t.id||!!t.domain);t&&r.setFrame("WOAR",`https://${n.A}/artist/${t.domain||t.id}`)}else t.artist?l=t.artist.split(",").map(t=>t.trim()):t.performer&&(l=t.performer.split(",").map(t=>t.trim()));if(l&&(r.setFrame("TPE1",l),e?.main_artists||r.setFrame("TPE2",l.join(", "))),t.release_audio_id&&r.setFrame("WOAF",`https://${n.A}/audio${t.release_audio_id}`),e){r.setFrame("TALB",e.title),e.year&&r.setFrame("TYER",e.year);const s=[e.owner_id,e.id];if(e.access_key&&s.push(e.access_key),r.setFrame("WOAS",`https://${n.A}/music/album/${s.join("_")}`),e.genres){const t=e.genres.map(t=>t.name);r.setFrame("TCON",t)}if(e.audios){const s=e.audios.findIndex(({id:e})=>e===t.id);-1!==s&&r.setFrame("TRCK",`${s+1}/${e.audios.length}`)}if(e.create_time){const t=d(e.create_time);r.setFrame("TDAT",t)}if(e.main_artists){const t=e.main_artists.map(t=>t.name);r.setFrame("TPE2",t.join(", "))}}else{const e=w[t.genre_id];e&&r.setFrame("TCON",[e])}if("string"==typeof t.title&&u.default.getValue("genius"))try{const e=await(0,c.A)({title:t.title,performer:(0,f.A)(t)||"",mainArtists:i,signal:s});e?.length&&r.setFrame("USLT",{description:"vknext.net",lyrics:e,language:""})}catch(t){console.error("error add lyrics to audio",t)}return r.addTag(),r.getBlob()}catch(t){console.error("Ошибка записи id3 тегов",t)}return _}},63989:(t,e,s)=>{s.d(e,{VZ:()=>r,fU:()=>n,oT:()=>a});class r extends Error{constructor(t){super(`Download task with ID ${t} not found.`),this.name="DownloadTaskNotFoundError"}}class a extends Error{constructor(t){super(`Download task with ID ${t} is already finished.`),this.name="DownloadTaskAlreadyFinishedError"}}class n extends Error{constructor(t){super(`Download task with ID ${t} has already timed out.`),this.name="DownloadTaskTimeoutError"}}},69106:(t,e,s)=>{s.d(e,{$:()=>o});var r=s(81621),a=s(24293),n=s(63989);const o=(0,r.vt)((t,e)=>{const s=t=>{const s=new Map(e().tasks).get(t);if(!s)throw new n.VZ(t);return s},r=e=>{t(t=>{const s=new Map(t.tasks),r=s.get(e);if(r?.onRemove)for(const t of r.onRemove)t();return s.delete(e),{tasks:s}})},o=o=>({setExtraText:e=>((e,r)=>{const a=s(e);t(t=>{const s=new Map(t.tasks);return s.set(e,{...a,extraText:r}),{tasks:s}})})(o,e),setPhotoUrl:e=>((e,r)=>{const a=s(e);t(t=>{const s=new Map(t.tasks);return s.set(e,{...a,photoUrl:r}),{tasks:s}})})(o,e),setTitle:e=>((e,r)=>{const a=s(e);t(t=>{const s=new Map(t.tasks);return s.set(e,{...a,title:r}),{tasks:s}})})(o,e),setProgress:r=>((r,o)=>{const i=s(r),l=new Map(e().tasks);if(i.status===a.h.FINISHED)throw new n.oT(r);t(()=>(l.set(r,{...i,progress:o,status:a.h.DOWNLOADING}),{tasks:l}))})(o,r),startArchiving:()=>(e=>{const r=s(e);t(t=>{const s=new Map(t.tasks);return s.set(e,{...r,status:a.h.ARCHIVING}),{tasks:s}})})(o),finish:e=>((e,o)=>{const i=s(e);if(i.status===a.h.FINISHED)throw new n.oT(e);if(i.timeoutId)throw new n.fU(e);const l=setTimeout(()=>r(e),60*(o?.onSave?15:5)*1e3);t(t=>{const s=new Map(t.tasks),r=new Set(i.onRemove);return o?.onRemove&&r.add(o.onRemove),s.set(e,{...i,onRemove:r,timeoutId:l,onSave:o?.onSave,status:a.h.FINISHED}),{tasks:s}})})(o,e),cancel:()=>(e=>{const r=s(e);for(const t of r.onCancel)t();t(t=>{const s=new Map(t.tasks);return s.delete(e),{tasks:s}})})(o),remove:()=>r(o)});return{tasks:new Map,startDownload:({id:e,onCancel:s,...r})=>{const n={...r,id:e,progress:{current:void 0,total:void 0},status:a.h.PREPARING,onCancel:new Set(s?[s]:[]),onRemove:new Set};t(t=>{const s=new Map(t.tasks);return s.set(e,n),{tasks:s}});const i=o(e);return{id:e,...i}},getTask:t=>{const e=s(t);return e?{...e}:void 0},getTaskHandlersById:o}})},69128:(t,e,s)=>{s.d(e,{Hq:()=>n,S:()=>l,_5:()=>i,cy:()=>o,hF:()=>a.h});var r=s(69106),a=s(24293);const n=t=>r.$.getState().startDownload(t),o=t=>r.$.getState().getTask(t),i=()=>(0,r.$)(t=>t.tasks),l=t=>(0,r.$)(t=>t.getTaskHandlersById)(t)},84896:(t,e,s)=>{s.d(e,{A:()=>o,Z:()=>n});var r=s(42791);const a=new Map,n=t=>{if(t.coverUrl_l)return t.coverUrl_l;if(t.coverUrl_m)return t.coverUrl_m;if(t.coverUrl_s)return t.coverUrl_s;if(Array.isArray(t.album))return null;const e=t.album?.thumb||t.photo;if(!e)return null;let s=0,r=null;for(const t of Object.keys(e)){const[,a]=t.split("_");a&&(Number(a)>s&&(s=+a,r=e[t]))}return r},o=t=>{const e=(t=>{const[e,s]=(0,r.A)(t);return[e,s].join("_")})(t);if(a.has(e))return a.get(e);const s=n(t);if(!s)return null;const o=fetch(s).then(t=>t.arrayBuffer());return a.set(e,o),o}},97992:(t,e,s)=>{s.d(e,{A:()=>r});const r=(t,e=100)=>{const s=[...t],r=[];for(;s.length;)r.push(s.splice(0,e||s.length));return r}}}]);