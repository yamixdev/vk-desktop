"use strict";(globalThis.webpackChunkvknext=globalThis.webpackChunkvknext||[]).push([[367,1243,1691,3470],{12225:(e,t,s)=>{s.d(t,{A:()=>n});var a=s(51018);const o=new Map,n=e=>{if(o.has(e))return o.get(e);const t=new a.e;return o.set(e,t),t}},14460:(e,t,s)=>{s.d(t,{A:()=>a});const a={deletedIcon:"q7DX20zs5iVed0ei"}},21243:(e,t,s)=>{s.r(t),s.d(t,{default:()=>n});var a=s(53778);class o extends a.default{constructor(){super("VKNExpiredMessages",{lifetime:5e3})}async getMessages(e,t){const s=await this.getStorage();return e in s?s[e]:t}async setMessages(e,t){const s=await this.getStorage();s[e]=t,this.saveStorage(s)}async removeMessages(e){const t=await this.getStorage();delete t[e],this.saveStorage(t)}}const n=new o},23804:(e,t,s)=>{s.d(t,{A:()=>d});var a=s(387),o=s(7618),n=s(32488),r=s(31691),i=s(21243),c=s(43024);let l=null,u=[];const d=async(e,t)=>{if(10004!==e[0])return;if("page"!==c.default.getValue("messagesSaveMode"))return;const s=c.default.getValue("nodeleteall"),d=c.default.getValue("hookBombs")&&await(0,n.default)(),g=c.default.getValue("showMessageHistory");if(!s&&!d&&!g)return;const f=e[1],h=e[2],m=e[3],w=e[4],p=e[5],v=e[6],y=e[7],S=e[9],M=t.getState().ownerId;if(y?.expire_ttl){const e=y.expire_ttl;if(d){const t=await i.default.getMessages(M,{}),s=(0,a.A)()+parseInt(e);t[m]={time:s},await i.default.setMessages(M,t)}}const A=o.z.isChatId(w)?Number(y?.from):2&h?M:w,_=`${M}_${m}`;let[b]=(await window.vkApi.api("messages.getById",{message_ids:[m]})).items;b||(b={id:m,random_id:S,conversation_message_id:f,text:v,date:p,peer_id:w,from_id:A,out:A===M?0:1});const I={kind:"NewMessage",src:1,...b};u.push([_,[I]]),l||(l=setTimeout(async()=>{try{await(async()=>{if(0===u.length)return;const e=await r.default.getStorage();for(const[t,s]of u)e[t]?e[t].push(...s):e[t]=s;await r.default.saveStorage(e),u=[],l=null})()}catch(e){console.error("Ошибка при сохранении событий:",e)}},3e3))}},31691:(e,t,s)=>{s.r(t),s.d(t,{default:()=>n});var a=s(53778);class o extends a.default{constructor(){super("StorageMessages",{lifetime:3e4})}async getMessages(e,t){const s=await this.getStorage();return e in s?s[e]:t}async setMessages(e,t){const s=await this.getStorage();s[e]=t,await this.saveStorage(s)}async removeMessages(e){const t=await this.getStorage();delete t[e],await this.saveStorage(t)}}const n=new o},37643:(e,t,s)=>{s.d(t,{A:()=>u});var a=s(74848),o=s(43171),n=s(3068),r=s(14460);const i=new Set;let c=!1;const l=async(e,t=0)=>{if(!t)return;const{default:r}=await Promise.all([s.e(961),s.e(7397),s.e(1649),s.e(8414),s.e(2665)]).then(s.bind(s,22665)),{unmount:l}=await(0,n.A)({root:e,content:(0,a.jsx)(r,{time:t}),noStyling:!0,disableAppRoot:!0,disableAnchorTextDecoration:!0,disableParentTransformForPositionFixedElements:!0});i.add(l),c||(c=!0,(0,o.A)(()=>{for(const e of i)e();i.clear(),c=!1}))},u=(e,t)=>{if(e.getElementsByClassName(r.A.deletedIcon).length)return;const s=e.querySelector(".ConvoMessageBottomInfo,.ConvoMessage__info");if(s){const a=document.createElement("span");return requestAnimationFrame(()=>{e.getElementsByClassName(r.A.deletedIcon).length?a.remove():l(a,t).catch(console.error)}),void s.append(a)}const a=e.querySelector(".ConvoMessageInfoWithoutBubbles");if(a){const s=document.createElement("div");s.className="ConvoMessageInfoWithoutBubbles__statusIcon",requestAnimationFrame(()=>{e.getElementsByClassName(r.A.deletedIcon).length?s.remove():l(s,t).catch(console.error)}),a.prepend(s)}}},40367:(e,t,s)=>{s.r(t),s.d(t,{default:()=>n});var a=s(53778);class o extends a.default{constructor(){super("VKNDeletedMessages",{lifetime:5e3})}async getMessages(e,t){const s=await this.getStorage();return e in s?s[e]:t}async setMessages(e,t){const s=await this.getStorage();s[e]=t,await this.saveStorage(s)}async removeMessages(e){const t=await this.getStorage();delete t[e],await this.saveStorage(t)}}const n=new o},51047:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t);var o=s(57580),n=s(387),r=s(32488),i=s(65879),c=s(43024),l=s(91674),u=s(53060),d=s(37643),g=s(62965),f=s(94301),h=s(23804),m=s(12225),w=e([o]);o=(w.then?(await w)():w)[0];const p=({engine:e,store:t})=>{if(e._fetchHooked)return;e._fetchHooked=!0;const s=e.fetchMaster;e.fetchMaster=async function(...e){const a=await Reflect.apply(s,this,e),o=[],i=(0,n.A)();for(const e of a.updates){0;try{const[s]=e;switch(s){case 10004:{o.push(e),(0,h.A)(e,t).catch(console.error);const s=t.getState(),a=s.convos.get(e[4])?.push?.mode;if("everything"===a){const t=(0,m.A)(s.viewer.id);for(const s of t.listeners)try{s(e)}catch(e){console.error(e)}}break}case 10002:{(0,g.A)(e,t).catch(console.error);const[,s,a,n]=e;if(131072&a&&c.default.getValue("showDeletedMsg")){(0,l.m)(n,s,i);const e=(0,u.A)(n,s);e&&(0,d.A)(e,i)}else o.push(e);break}case 10019:if(c.default.getValue("showBombsMsg")&&await(0,r.default)()){const s=t.getState().convos.get(e[2])?.history?.confirmed,a=s&&s.find(({item:t})=>t?.cmid===e[1]);a?.item?.expireTTL||o.push(e)}else o.push(e);break;case 10005:(0,f.A)(e,t).catch(console.error),c.default.getValue("showBombsMsg")&&await(0,r.default)()&&e[6]?.expire_ttl||o.push(e);break;default:o.push(e)}}catch(e){console.error(e)}}return a.updates=o,a}},v=async()=>{p(await(0,i.A)())};0,c.default.onInited(v),a()}catch(e){a(e)}})},53060:(e,t,s)=>{s.d(t,{A:()=>o});var a=s(95728);const o=(e,t)=>{for(const s of document.querySelectorAll(".ConvoMessage,.ConvoMessageWithoutBubble")){const{fiber:o}=(0,a.A)(s),n=o?.return?.memoizedProps?.message;if(n&&(n.peerId===e&&n.cmid===t))return s}return null}},62965:(e,t,s)=>{s.d(t,{A:()=>c});var a=s(387),o=s(40367),n=s(43024);let r=null,i=[];const c=async(e,t)=>{if("page"!==n.default.getValue("messagesSaveMode"))return;if(10002!==e[0])return;const s=e[4],c=e[2],l=t.getState().ownerId;if(!(131072&c))return;if(!n.default.getValue("nodeleteall"))return;const u=(0,a.A)();i.push([l,s,u]),r||(r=setTimeout(async()=>{try{await(async()=>{if(0===i.length)return;const e=await o.default.getStorage();for(const[t,s,a]of i){const o=e[t]||{};o[s]={time:a},e[t]=o}await o.default.saveStorage(e),i=[],r=null})()}catch(e){console.error("Ошибка при сохранении событий:",e)}},3e3))}},91674:(e,t,s)=>{s.d(t,{_:()=>n,m:()=>o});const a=new Map,o=(e,t,s)=>{a.set(`${e}_${t}`,s)},n=(e,t)=>a.get(`${e}_${t}`)},94301:(e,t,s)=>{s.d(t,{A:()=>c});var a=s(7618),o=s(31691),n=s(43024);let r=null,i=[];const c=async(e,t)=>{if("page"!==n.default.getValue("messagesSaveMode"))return;if(10005!==e[0])return;const[s,c,l,u,d,g,f,h,m,w,p]=e,v=t.getState().ownerId;if(f?.is_expired)return;const y=a.z.isChatId(u)?Number(f?.from):2&l?v:u;let[S]=(await window.vkApi.api("messages.getById",{message_ids:[w]})).items;S||(S={id:w,random_id:m,conversation_message_id:c,text:g,date:d,update_time:p,peer_id:u,from_id:y,out:y===v?0:1});const M={kind:"NewMessage",...S};i.push([`${v}_${w}`,[M]]),r||(r=setTimeout(async()=>{try{await(async()=>{if(0===i.length)return;const e=await o.default.getStorage();for(const[t,s]of i)e[t]?e[t].push(...s):e[t]=s;await o.default.saveStorage(e),i=[],r=null})()}catch(e){console.error("Ошибка при сохранении событий:",e)}},3e3))}}}]);